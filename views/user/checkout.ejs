<%- include('../partials/user-header') %>
<br><br><br><br><br><br>
<!-- 
<p>
  <a class="btn btn-primary" data-bs-toggle="collapse" href="#multiCollapseExample1" role="button" aria-expanded="false" aria-controls="multiCollapseExample1">Toggle first element</a>
</p>
<div class="row">
  <div class="col">
    <div class="collapse multi-collapse" id="multiCollapseExample1">
      <div class="card card-body" style="width:350px; ;" >
        Some placeholder content for the
      </div>
    </div>
  </div>
  <div class="col">
    <div class="collapse multi-collapse" id="multiCollapseExample2">
      <div class="card card-body">
        Some placeholder content for the second collapse component of this multi-collapse example. This panel is hidden by default but revealed when the user activates the relevant trigger.
      </div>
    </div>
  </div>
</div> -->


<% if(user.Address.length>0) {%>
<div class="container">
  <div class="row" id="userAddress">
    <% user.Address.forEach((userAddress,index) => {%>
    <div class="col-lg-4  p-md-5 " id="">
      <div class="card">
        <div class="card-body">
          <!-- <form action="/placeOrder" method="post" id="orderForm"> -->
          <h5 class="card-title">
            <ion-icon name="location-outline"></ion-icon>

          </h5>
          <address class="card-text"><%= userAddress.firstName + ' ' +userAddress.lastName %><br>
            <%= userAddress.house %>,<br>
            <%= userAddress.address %><br><%= userAddress.city%>, <br>
            <%= userAddress.state %>, <br>
            Pincode :<%= userAddress.pincode %><br>
            Ph :<%= userAddress.phone %>
          </address>
          <ul class="list-inline m-0">
            <div class="form-check">
              <input class="form-check-input" type="radio" value="<%= index %>" name="addressPosition" id="addressPosition" onclick="getAddressIndex('<%=userAddress.id%>')">
              <label class="form-check-label" for="flexCheckIndeterminate">
              </label>
              <li class="list-inline-item float-end">
                <button data-bs-toggle="modal" data-placement="top" data-bs-target="#exampleModa"><i class="bi bi-pen"></i></button>
                <button onclick="deleteAddress('<%=userAddress.id%>')" data-toggle="tooltip" data-placement="top" title="Delete"><i class="bi bi-trash" style="font-size: 1.2rem; color: rgb(255, 0, 0);"></i></button></a>
              </li>
            </div>
          </ul>
        </div>
      </div>
    </div>
    <div class="modal fade" id="exampleModa" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Edit Address</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="card-body">
            <form action="/editAddress/<%= userAddress.id %>" method="post">
              <div class="row mt-2">
                <div class="col-md-6">
                  <label class="labels">First Name</label>
                  <input type="text" class="form-control" placeholder="" value="<%= userAddress.firstName%>" name="firstName" required>
                </div>
                <div class="col-md-6">
                  <label class="labels">Last Name</label>
                  <input type="text" class="form-control" value="<%=userAddress.lastName %>" placeholder="" name="lastName" required>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-md-12">
                  <label class="labels">Address</label>
                  <input type="text" class="form-control" placeholder="Flat, House no., Building," value="<%= userAddress.house %>" name="house"><br>
                  <input type="text" class="form-control" placeholder="Area, Street,Village" value=" <%= userAddress.address %>" name="address">
                </div>
                <div class="col-md-12">
                  <label class="labels">Town/City</label>
                  <input type="text" class="form-control" placeholder="" value="<%= userAddress.city%>" name="city" required>
                </div>
                <div class="col-md-12">
                  <label class="labels">State</label>
                  <input type="text" class="form-control" placeholder="" value=" <%= userAddress.state %>" name="state" id="state" required>
                </div>
                <div class="col-md-12">
                  <label class="labels">Pincode</label>
                  <input type="text" class="form-control" placeholder="6-digits" value="<%= userAddress.pincode %>" name="pincode" maxlength="6" minlength="6" required>
                </div>
                <div class="col-md-12">
                  <label class="labels">Mobile number</label>
                  <input type="text" class="form-control" placeholder="" value="<%= userAddress.phone %>" maxlength="10" minlength="10" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Edit</button>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>
  <% }) %>
</div>
<% } %>

<!-- Checkout Section Begin -->
<section class="checkout spad">
  <div class="container">
    <div class="checkout__form">
      <h4>Shipping Details</h4>

      <div class="row">
        <div class="col-lg-6 col-md-1">
          <form action="/addAddress" method="post">
            <h5>Add New Address</h5>
            <div class="row mt-2">
              <div class="col-md-6">
                <label class="labels">First Name</label>
                <input type="text" class="form-control" placeholder="" value="" name="firstName" required>
              </div>
              <div class="col-md-6">
                <label class="labels">Last Name</label>
                <input type="text" class="form-control" value="" placeholder="" name="lastName" required>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-12">
                <label class="labels">Address</label>
                <input type="text" class="form-control" placeholder="Flat, House no., Building," value="" name="house" required><br>
                <input type="text" class="form-control" placeholder="Area, Street,Village" value="" name="address" required>
              </div>
              <div class="col-md-12">
                <label class="labels">Town/City</label>
                <input type="text" class="form-control" placeholder="" value="" name="city" required>
              </div>
              <div class="col-md-12">
                <label class="labels">State</label>
                <input type="text" class="form-control" placeholder="" value="" name="state" id="state" required>
              </div>
              <div class="col-md-12">
                <label class="labels">Pincode</label>
                <input type="text" class="form-control" placeholder="6-digits" value="" name="pincode" minlength="6" maxlength="6" required>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-md-6">
                <label class="labels">Mobile Number</label>
                <input type="text" class="form-control" placeholder="" value="" name="phone" required>
              </div>
              <div class="col-md-6">
                <label class="labels">email</label>
                <input type="text" class="form-control" value="<%=user.email %>" placeholder="">
              </div>
            </div>
            <div class="py-5 md-3"><button class="btn btn-primary rounded-pill py-sm-3 px-sm-5" type="submit">Add Address</button></div>
          </form>
        </div>





        <div class="col-lg-6 col-md-6">
          <form action="/placeOrder" method="post" id="orderForm">
            <% if(findCart.products.length >0) {%>

            <div class="checkout__order">

              <h4>Your Order</h4>
              <div class="checkout__order__products">Products <span>Total</span></div>
              <% findCart.products.forEach((listItem)=> { %>
              <ul>
                <li><%= listItem.name %> <span>₹ <%= listItem.offerPrice.toFixed(2) ? (listItem.quantity.toFixed(2) * listItem.offerPrice.toFixed(2)) : (listItem.quantity.toFixed(2) * listItem.price.toFixed(2)) %> </span></li>
              </ul>
              <% }) %>
              <div class="checkout__order__subtotal">Subtotal <span>₹ <del><%= findCart.subTotal %></del></span></div>
              <div class="checkout__order__total">Discount<span>₹ <%= (findCart.subTotal.toFixed(2) - findCart.total.toFixed(2)) %></span></div>
              <% if(couponCode) {%>
              <div class="checkout__order__total">coupon code<span class="text-muted">₹ <%=couponCode%></span></div>
              <div class="checkout__order__total">Coupon Discount<span class="text-muted">₹ <%=couponDiscount  %></span></div>
              <div class="checkout__order__total">Total <span>₹ <%= (findCart.total - couponDiscount) %></span></div>
              <% } else {%>
              <div class="checkout__order__total">Total <span>₹ <%= findCart.total%></span></div>
              <% } %>
              <div class="checkout__input__checkbox">
                <label for="payment">
                  Cash On Delivery
                  <input type="radio" id="cod" name="paymentType" value="cash-on-elivery" checked>
                  <span class="checkmark"></span>
                </label>
              </div>
              <div class="checkout__input__checkbox">
                <label for="paypal">
                  online payment
                  <input type="radio" id="online-payment" name="paymentType" value="razorPay">
                  <span class="checkmark"></span>

                </label>
              </div>
              <input type="hidden" value="" id="myAddress" name="myAddress">
              <button type="submit" class="btn btn-primary rounded-pill py-sm-3 px-sm-5">PLACE ORDER</button>

            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>
<% } %>

<!-- Checkout Section End -->

<%- include("../partials/footer") %>

<script src="/js/checkout.js"></script>


<script>
  function getAddressIndex(id) {
    let address = document.getElementById("myAddress").value = id
  }
  console.log(address);
  document.forms["orderForm"].addEventListener("submit", async (event) => {
    event.preventDefault();
    const paymentType = $('input[name=paymentType]:checked', '#orderForm').val()
    console.log(paymentType);
    if (paymentType == "cashonDelivery") {

      checkout(address)

    }
  });

  async function checkout(address) {
    try {
      const response = await axios({
        url: '/placeOrder',
        method: 'post',
        data: address
      })
      if (response.status == 200) {

        await Swal.fire(
          'success!',
          `You saved money`,
          'success'

        )
      }

    } catch (error) {

    }
  }
</script>